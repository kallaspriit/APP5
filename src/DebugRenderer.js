define(["jquery","Debug","ResourceManager","Util","underscore"],function(e,t,n,r,i){var o=function(){this.ui=null,this._errorStack=[]};return o.prototype.init=function(e){var t=this;return this.ui=e,this._initCss(function(){t._initHtml(),t._initEvents()}),this},o.prototype.showError=function(t,n,i,o){var a,s,l=this,u=e("#debug-renderer-error"),c="";if(r.isString(t))a={title:t,message:n,location:i,stack:o},this._errorStack.push(r.clone(a));else{if(!(this._errorStack.length>0))return;a=this._errorStack[this._errorStack.length-1]}if(a.title=a.title||"System Error Occured",a.message=a.message||"A system error occured, sorry for the inconvenience.",a.location=a.location||"",a.message="<p><strong>"+a.message.replace("<","&lt;").replace(">","&gt;")+"</strong></p>",this._errorStack.length>1&&(a.title+=" ("+(this._errorStack.length-1)+" more)"),r.isArray(a.stack)&&a.stack.length>0){for(s=0;a.stack.length>s;s++)s>0&&(c+="<br>"),c+="#"+(s+1)+" "+a.stack[s].filename+":"+a.stack[s].line+" - "+a.stack[s].method;a.message+="<p>"+c+"</p>"}0===u.length&&(e(document.body).append('<div id="debug-renderer-error">	<div class="debug-renderer-error-inner">		<h1 class="debug-renderer-error-title"></h1>		<div class="debug-renderer-error-close">&times;</div>		<div class="debug-renderer-error-content"></div>		<div class="debug-renderer-error-location"></div>	</div></div>'),u=e("#debug-renderer-error")),u.find(".debug-renderer-error-title").html(a.title),u.find(".debug-renderer-error-content").html(a.message),a.location.length>0?u.find(".debug-renderer-error-location").html(a.location):u.find(".debug-renderer-error-location").hide(),u.find(".debug-renderer-error-close").click(function(){u.fadeOut(function(){e(this).remove(),l._errorStack.pop(),l._errorStack.length>0&&l.showError()})}),u.fadeIn()},o.prototype._initCss=function(e){n.loadCss("style/debug-renderer.css",e)},o.prototype._initHtml=function(){e(document.body).append('<div id="debug-renderer"></div>'),e(document.body).hasClass("with-touch")&&e("#debug-renderer").click(function(){e(this).toggleClass("visible")})},o.prototype._initEvents=function(){var e=this;require(["Navi"],function(e){e.on(e.Event.PRE_NAVIGATE,function(e){t.log("! Navigating to "+e.module+"::"+e.action,e.parameters)})}),n.on(n.Event.MODULE_LOADED,function(e){t.log("+ Loaded module "+e.name)}),n.on(n.Event.VIEW_LOADED,function(e){t.log("+ Loaded view "+e.filename)}),n.on(n.Event.LOAD_ERROR,function(e){switch(e.resource){case n.ResourceType.REQUEST:t.error('Requesting "'+e.url+'" failed: '+e.message);break;case n.ResourceType.FILE:!r.isUndefined(e.error)&&r.isArray(e.error.requireModules)?t.error("Requiring modules failed: "+JSON.stringify(e.error.requireModules)):t.error("Loading file failed",e);break;case n.ResourceType.MODULE:t.error('Loading module "'+e.name+'" from "'+e.filename+'" failed, invalid return?');break;case n.ResourceType.MODULE_TRANSLATIONS:t.error('Loading module "'+e.name+'" translations from "'+e.filename+'" failed, invalid return?');break;case n.ResourceType.VIEW:t.error('Loading module "'+e.name+'" translations from "'+e.filename+'" failed');break;case n.ResourceType.CSS:t.error('Loading css file "'+e.filename+'" failed')}}),t.on(t.Event.CONSOLE,function(e){var t,n=[];for(r.isObject(e.source)&&n.push(r.formatPath(e.source.filename)+":"+e.source.line),t=0;e.args.length>t;t++)n.push(e.args[t]);r.isFunction(console.log.apply)?console.log.apply(console,n):console.log(n)}),t.on(t.Event.LOG,function(t){var n="info",i=t.args[0];if(!r.isString(i)){if(!r.isFunction(""+i))return;i=""+i}var o=i.substr(0,2),a=e._formatContent(t.args);"+ "===o?n="success":"- "===o?n="error":"> "===o?n="tx":"< "===o&&(n="rx"),e._appendMessage(n,a,t.source)}),t.on(t.Event.ALERT,function(t){var n=e._formatContent(t.args);e._appendMessage("alert",n,t.source)}),t.on(t.Event.ERROR,function(t){function n(e){return e instanceof Error&&(e.stack?e=e.message&&-1===e.stack.indexOf(e.message)?"Error: "+e.message+"\n"+e.stack:e.stack:e.sourceURL&&(e=e.message+"\n"+e.sourceURL+":"+e.line)),e}var o=[];i.each(t.args,function(e){o.push(n(e))}),r.isFunction(console.error.apply)?console.error.apply(console,o):console.error(o);var a="Unknown error",s=[],l="unknown",u="?";3===t.args.length&&r.isNumber(t.args[2])?(a=t.args[0],l=t.args[1],u=t.args[2]):1===t.args.length&&r.isError(t.args[0])?(a=t.args[0].message,r.isArray(t.args)&&t.args.length>0&&r.isString(t.args[0].stack)&&(s=i.filter(i.map(t.args[0].stack.split("\n"),function(e){return r.parseStackLine(e)}),function(e){return null!==e}),l=s[0].filename,u=s[0].line)):1===t.args.length&&r.isString(t.args[0])&&(t.args.length>0&&(a=t.args[0]),r.isObject(t.source)&&r.isString(t.source.filename)&&(l=t.source.filename,r.isNumber(t.source.line)&&(u=t.source.line))),e.showError("System Error Occured",a,l+":"+u,s);var c,f="";if(s.length>0)for(c=0;s.length>c;c++)c>0&&(f+="<br>"),f+="#"+(c+1)+" "+s[c].filename+":"+s[c].line+" - "+s[c].method;e._appendMessage("error",a+(f.length>0?"<br>"+f:""),{filename:l,line:u})})},o.prototype._appendMessage=function(t,n,i){var o,a=e("#debug-renderer"),s=100,l=a.find("div"),u=l.length;u>s-1&&e(l.splice(0,u-(s-1))).remove(),o=r.isObject(i)?r.formatPath(i.filename)+":"+i.line:"<em>unknown</em>",a.append('<div class="'+t+'">'+n+"<span>"+o+"</span></div> "),a.prop("scrollTop",a.prop("scrollHeight"))},o.prototype._formatContent=function(e){for(var t,n="",i=0;e.length>i;i++)t=e[i],0===i&&r.isString(t)&&/[\-+<>!] /.test(t)&&(t=t.substr(2)),n.length>0&&(n+=", "),n+=r.str(t);return n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},new o});