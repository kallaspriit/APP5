define(["router/RouterBase","config/main","config/routes","Navi","App","Util"],function(e,t,n,r,i,o){var a=function(){e.call(this),this._currentRouteName=null};return a.prototype=Object.create(e.prototype),a.prototype.Param={STRING:"string",INT:"int",POS_INT:"+int"},a.prototype.ParamDefaults={string:"","int":0,"+int":1},a.prototype.init=function(){var e=this;return r.on(r.Event.URL_CHANGED,function(t){e._onUrlChanged(t.parameters)}),this},a.prototype.navigate=function(e,t,n){if(o.isUndefined(t)||o.isObject(t)){var r=e,a=t,s=n;return this.open(r,a,s),void 0}var l,u="/"+e+"/"+t;if(o.isObject(n)&&!o.isEmpty(n))for(l in n)u+=n[l]===!0?"/"+l:"/"+l+"="+n[l];i.location.path(u),i.validate()},a.prototype.open=function(e,t,r){if(!o.isObject(n[e]))throw Error('Route "'+e+'" not found');var a,s,l=this._parseRoute(n[e]),u=l.path;for(o.isObject(t)&&o.extend(l.parameters,t),s=0;l.tokens.length>s;s++)a=l.tokens[s],"static"!=a.type&&(o.isUndefined(l.parameters[a.name])&&(l.parameters[a.name]=this.ParamDefaults[a.type]),u=u.replace(a.original,l.parameters[a.name]));i.location.path("/"+u),r&&i.location.replace(),i.validate()},a.prototype.setUrlParameter=function(e,t,n){var i,a=r.getCurrent();return null===a?!1:(i=o.clone(a),i.parameters[e]=t,null!==this._currentRouteName?r.open(this._currentRouteName,i.parameters,n):r.open(i.module,i.action,i.parameters),void 0)},a.prototype._onUrlChanged=function(e){var i,a,s,l=e.path;for(i in n)if(a=this._parseRoute(n[i]),a.name=i,s=this._matchRoute(a,l),null!==s)return this._currentRouteName=i,r._open(a.module,a.action,s),void 0;this._currentRouteName=null;var u,c,p,f,d=l.split("/"),h=t.index.module,m=t.index.action,g=t.index.parameters,v=!0;if(d.length>=2&&d[1].length>0&&(h=d[1],g={},v=!1),d.length>=3&&d[2].length>0&&(m=d[2],v=!1),d.length>=4){for(u=3;d.length>u;u++)-1!==d[u].indexOf("=")?(c=d[u].split("="),p=c[0],f=o.normalizeType(c[1])):(p=d[u],f=!0),g[p]=f;v=!1}v&&o.isString(t.index.route)&&(this._currentRouteName=t.index.route),o.normalizeType(g),r._open(h,m,g)},a.prototype._parseRoute=function(e){var t=[];if(e.path.length>0){var n,r=e.path.split("/");for(n=0;r.length>n;n++)":"===r[n].substr(0,1)?t.push(this._parseRouteParameter(r[n])):t.push({original:r[n],type:"static",name:r[n]})}return{path:e.path,module:e.module,action:e.action,parameters:e.parameters||{},tokens:t}},a.prototype._parseRouteParameter=function(e){var t=e.substr(1);if(-1===t.indexOf("["))return{original:e,type:this.Param.STRING,name:t};var n=/(\w+)\[([+\w]+)\]/,r=n.exec(t);return{original:e,type:r[2],name:r[1]}},a.prototype._matchRoute=function(e,t){"/"===t.substr(0,1)&&(t=t.substr(1));var n,r,i,a=t.split("/"),s=!0,l={};for(i=0;a.length>i;i++){if(o.isUndefined(e.tokens[i])){s=!1;break}if(n=a[i],r=e.tokens[i],!this._matchTokens(n,r)){s=!1;break}"static"!==r.type&&(l[r.name]=n)}return o.normalizeType(l),s?l:null},a.prototype._matchTokens=function(e,t){if("static"===t.type){if(e!==t.name)return!1}else if(t.type===this.Param.STRING){if(!o.isString(e)&&!o.isNumber(e))return!1}else if(t.type===this.Param.INT){if(parseInt(e,10)+""!==e)return!1}else if(t.type===this.Param.POS_INT&&(parseInt(e,10)+""!==e||1>parseInt(e,10)))return!1;return!0},new a});