define(["router/RouterBase","config/main","config/routes","Navi","App","Util"],function(e,t,n,r,i,o){var a=function(){this._currentRouteName=null};return a.prototype=new e,a.prototype.Param={STRING:"string",INT:"int",POS_INT:"+int"},a.prototype.ParamDefaults={string:"","int":0,"+int":1},a.prototype.init=function(){var e=this;return r.bind(r.Event.URL_CHANGED,function(t){e._onUrlChanged(t.parameters)}),this},a.prototype.navigate=function(e,t,n){if(o.isUndefined(t)||o.isObject(t)){var r=e,a=t,s=n;return this.open(r,a,s),void 0}var u,l="/"+e+"/"+t;if(o.isObject(n)&&!o.isEmpty(n))for(u in n)l+=n[u]===!0?"/"+u:"/"+u+"="+n[u];i.location.path(l),i.validate()},a.prototype.open=function(e,t,r){if(!o.isObject(n[e]))throw Error('Route "'+e+'" not found');var a,s,u=this._parseRoute(n[e]),l=u.path;for(o.isObject(t)&&o.extend(u.parameters,t),s=0;u.tokens.length>s;s++)a=u.tokens[s],"static"!=a.type&&(o.isUndefined(u.parameters[a.name])&&(u.parameters[a.name]=this.ParamDefaults[a.type]),l=l.replace(a.original,u.parameters[a.name]));i.location.path("/"+l),r&&i.location.replace(),i.validate()},a.prototype.setUrlParameter=function(e,t,n){var i,a=r.getCurrent();return null===a?!1:(i=o.clone(a),i.parameters[e]=t,null!==this._currentRouteName?r.open(this._currentRouteName,i.parameters,n):r.open(i.module,i.action,i.parameters),void 0)},a.prototype._onUrlChanged=function(e){var i,a,s,u=e.path;for(i in n)if(a=this._parseRoute(n[i]),a.name=i,s=this._matchRoute(a,u),null!==s)return this._currentRouteName=i,r._open(a.module,a.action,s),void 0;this._currentRouteName=null;var l,c,f,h,p=u.split("/"),d=t.index.module,m=t.index.action,g=t.index.parameters,v=!0;if(p.length>=2&&p[1].length>0&&(d=p[1],g={},v=!1),p.length>=3&&p[2].length>0&&(m=p[2],v=!1),p.length>=4){for(l=3;p.length>l;l++)-1!==p[l].indexOf("=")?(c=p[l].split("="),f=c[0],h=o.normalizeType(c[1])):(f=p[l],h=!0),g[f]=h;v=!1}v&&o.isString(t.index.route)&&(this._currentRouteName=t.index.route),o.normalizeType(g),r._open(d,m,g)},a.prototype._parseRoute=function(e){var t=[];if(e.path.length>0){var n,r=e.path.split("/");for(n=0;r.length>n;n++)":"===r[n].substr(0,1)?t.push(this._parseRouteParameter(r[n])):t.push({original:r[n],type:"static",name:r[n]})}return{path:e.path,module:e.module,action:e.action,parameters:e.parameters||{},tokens:t}},a.prototype._parseRouteParameter=function(e){var t=e.substr(1);if(-1===t.indexOf("["))return{original:e,type:this.Param.STRING,name:t};var n=/(\w+)\[([+\w]+)\]/,r=n.exec(t);return{original:e,type:r[2],name:r[1]}},a.prototype._matchRoute=function(e,t){"/"===t.substr(0,1)&&(t=t.substr(1));var n,r,i,a=t.split("/"),s=!0,u={};for(i=0;a.length>i;i++){if(o.isUndefined(e.tokens[i])){s=!1;break}if(n=a[i],r=e.tokens[i],!this._matchTokens(n,r)){s=!1;break}"static"!==r.type&&(u[r.name]=n)}return o.normalizeType(u),s?u:null},a.prototype._matchTokens=function(e,t){if("static"===t.type){if(e!==t.name)return!1}else if(t.type===this.Param.STRING){if(!o.isString(e)&&!o.isNumber(e))return!1}else if(t.type===this.Param.INT){if(parseInt(e,10)+""!==e)return!1}else if(t.type===this.Param.POS_INT&&(parseInt(e,10)+""!==e||1>parseInt(e,10)))return!1;return!0},new a});