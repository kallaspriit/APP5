define(["underscore","EventEmitter","Deferred","App","Debug","Util","UI","ResourceManager","Keyboard","Mouse"],function(e,t,n,r,i,o,a,s,l,u){var c=function(){t.call(this),this.router=null,this.backPossible=!1,this._stack=[],this._naviCounter=0,this._partialRendering=!1};return c.prototype=Object.create(t.prototype),c.prototype.Event={PRE_NAVIGATE:"pre-navigate",POST_NAVIGATE:"post-navigate",PRE_PARTIAL:"pre-partial",POST_PARTIAL:"post-partial",STACK_CHANGED:"stack-changed",URL_CHANGED:"url-changed",PARAMETERS_CHANGED:"parameters-changed",SLEEP:"sleep",WAKEUP:"wakeup",EXIT:"exit"},c.prototype.init=function(){var e=this;return l.on([l.Event.KEYDOWN,l.Event.KEYUP],function(t){e._onKeyEvent(t.info)}),u.on([u.Event.MOUSEDOWN,u.Event.MOUSEUP,u.Event.MOUSEMOVE],function(t){e._onMouseEvent(t.info)}),this.on(this.Event.STACK_CHANGED,function(){e.backPossible=e.isBackPossible()}),this},c.prototype.open=function(e,t,n){a.isTransitioning()||this.router.navigate(e,t,n)},c.prototype._open=function(e,t,r){if(t=t||"index",r=r||[],!a.isTransitioning()){var i=this,l=new n,u=o.convertEntityName(e)+"Module",c=o.convertCallableName(t)+"Action",p="modules/"+e+"/style/"+e+"-module.css",f="modules/"+e+"/views/"+e+"-"+t+".html";return this.emit({type:this.Event.PRE_NAVIGATE,module:e,action:t,parameters:r}),o.when(s.loadModule(e),s.loadView(f),s.loadCss(p)).done(function(n,o){i._showAction(e,t,n,o,u,c,l,r)}).fail(function(){throw Error('Loading module "'+e+'" resources failed')}),l.promise()}},c.prototype._showAction=function(e,t,n,i,s,l,u,c){if(!o.isFunction(n[l])&&!o.isArray(n[l]))throw Error('Invalid "'+e+'" module action "'+t+'" requested');var p,f=this,d=this.getCurrent(),h=this.getExistingItem(e,t),m=null,g=!1,v=null;if(null!==d&&d===h)return d.emit(this.Event.URL_CHANGED),this.emit({type:this.Event.PARAMETERS_CHANGED,module:e,action:t,parameters:c}),void 0;if(null!==h){for(;this._stack.length>0;)if(p=this.peekLast(),p!==d){if(p===h)break;this.popLast(),p.emit(this.Event.EXIT),null!==p.container&&p.container.remove()}else this.popLast();g=!0,h.emit(this.Event.WAKEUP)}null!==h&&null===h.container&&(g=!1),g?d.emit(this.Event.EXIT):(r.parameters=c,r.registerController(s+"."+l,n[l]),null!==h?m=h:(m=this.appendNavigation(e,t,c),m.emit=function(e,t){var n=this.container.data("$scope");o.isObject(n)&&o.isFunction(n.$broadcast)&&n.$broadcast(e,t)}),null!==d&&d.emit(this.Event.SLEEP)),v=a.showView(e,t,s,l,c,n,i,null!==d?d.container:null,null!==h?h.container:null,null!==m?m.id:null,g,function(){g&&(d.emit(f.Event.EXIT),d.container.remove()),f.emit({type:f.Event.POST_NAVIGATE,module:e,action:t,parameters:c}),u.resolve(),r.validate()}),null!==m&&(m.container=v)},c.prototype.partial=function(e,t,i,l,u){i=i||"index",l=l||[],u=o.isBoolean(u)?u:!1,this._partialRendering=!0;var c=this,p=new n,f=o.convertEntityName(t)+"Module",d=o.convertCallableName(i)+"Action",h="modules/"+t+"/style/"+t+"-module.css",m="modules/"+t+"/views/"+t+"-"+i+".html",g=null;return this.emit({type:this.Event.PRE_PARTIAL,containerSelector:e,module:t,action:i,parameters:l}),o.when(s.loadModule(t),s.loadView(m),s.loadCss(h)).done(function(n,o){g=a.showPartial(t,i,f,d,l,n,o,e,u),c.emit({type:c.Event.POST_PARTIAL,containerSelector:e,module:t,action:i,parameters:l}),p.resolve(g),r.validate(),c._partialRendering=!1}).fail(function(){throw Error('Loading module "'+t+'" resources failed')}),p.promise()},c.prototype.back=function(){var e=this.getCurrent(),t=this.getPrevious();null!==e&&null!==t&&window.history.back()},c.prototype.setUrlParameter=function(e,t,n){if(o.isFunction(this.router.setUrlParameter))return this.router.setUrlParameter(e,t,n);var r,i=this.getCurrent();return null===i?!1:(r=o.clone(i),r.parameters[e]=t,this.open(r.module,r.action,r.parameters),void 0)},c.prototype.getCurrent=function(){return 0===this._stack.length?null:this._stack[this._stack.length-1]},c.prototype.getPrevious=function(){return 2>this._stack.length?null:this._stack[this._stack.length-2]},c.prototype.isBackPossible=function(){return this._stack.length>=2},c.prototype.clearHistory=function(){this._stack=[],this.emit({type:this.Event.STACK_CHANGED,stack:this._stack})},c.prototype.getExistingItem=function(e,t){var n,r;for(n=0;this._stack.length>n;n++)if(r=this._stack[n],r.module===e&&r.action===t)return r;return null},c.prototype.getStack=function(){return this._stack},c.prototype._onUrlChanged=function(e){this.emit({type:this.Event.URL_CHANGED,parameters:e})},c.prototype._popLastAction=function(e){if(e=e||1,this._stack.length>=2){for(var t=0;e>t;t++)this._removeCurrentAction();var n=this._stack.pop();return this.emit({type:this.Event.STACK_CHANGED,stack:this._stack}),n}return null},c.prototype.peekLast=function(){return 0===this._stack.length?null:this._stack[this._stack.length-1]},c.prototype.popLast=function(){if(0===this._stack.length)return null;var e=this._stack.pop();return this.emit({type:this.Event.STACK_CHANGED,stack:this._stack}),e},c.prototype._removeCurrentAction=function(){this._stack.length>=1&&this._stack.pop(),this.emit({type:this.Event.STACK_CHANGED,stack:this._stack})},c.prototype.appendNavigation=function(e,t,n){return this._stack.push({id:this._naviCounter++,module:e,action:t,parameters:o.isObject(n)?n:{},level:this._stack.length,container:null,emit:function(){}}),this.emit({type:this.Event.STACK_CHANGED,stack:this._stack}),this._stack[this._stack.length-1]},c.prototype.prependNavigation=function(e,t,n){this._stack.unshift({id:this._naviCounter++,module:e,action:t,parameters:o.isObject(n)?n:{},level:0,container:null,emit:function(){}});for(var r=1;this._stack.length>r;r++)this._stack[r].level++;return this.emit({type:this.Event.STACK_CHANGED,stack:this._stack}),this._stack[0]},c.prototype._onKeyEvent=function(e){var t=this.getCurrent();null!==t&&o.isFunction(t.emit)&&t.emit(e.type,e)},c.prototype._onMouseEvent=function(e){var t=this.getCurrent();null!==t&&o.isFunction(t.emit)&&t.emit(e.type,e)},new c});