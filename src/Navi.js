define(["underscore","Bindable","Deferred","App","Debug","Util","UI","ResourceManager","Keyboard","Mouse"],function(e,t,n,r,i,o,a,s,u,l){var c=function(){this.router=null,this.backPossible=!1,this._stack=[],this._naviCounter=0,this._partialRendering=!1};return c.prototype=new t,c.prototype.Event={PRE_NAVIGATE:"pre-navigate",POST_NAVIGATE:"post-navigate",PRE_PARTIAL:"pre-partial",POST_PARTIAL:"post-partial",STACK_CHANGED:"stack-changed",URL_CHANGED:"url-changed",PARAMETERS_CHANGED:"parameters-changed",SLEEP:"sleep",WAKEUP:"wakeup",EXIT:"exit"},c.prototype.init=function(){var e=this;return u.bind([u.Event.KEYDOWN,u.Event.KEYUP],function(t){e._onKeyEvent(t.info)}),l.bind([l.Event.MOUSEDOWN,l.Event.MOUSEUP,l.Event.MOUSEMOVE],function(t){e._onMouseEvent(t.info)}),this.bind(this.Event.STACK_CHANGED,function(){e.backPossible=e.isBackPossible()}),this},c.prototype.open=function(e,t,n){a.isTransitioning()||this.router.navigate(e,t,n)},c.prototype._open=function(e,t,r){if(t=t||"index",r=r||[],!a.isTransitioning()){var i=this,u=new n,l=o.convertEntityName(e)+"Module",c=o.convertCallableName(t)+"Action",f="modules/"+e+"/style/"+e+"-module.css",h="modules/"+e+"/views/"+e+"-"+t+".html";return this.fire({type:this.Event.PRE_NAVIGATE,module:e,action:t,parameters:r}),o.when(s.loadModule(e),s.loadView(h),s.loadCss(f)).done(function(n,o){i._showAction(e,t,n,o,l,c,u,r)}).fail(function(){throw Error('Loading module "'+e+'" resources failed')}),u.promise()}},c.prototype._showAction=function(e,t,n,i,s,u,l,c){if(!o.isFunction(n[u])&&!o.isArray(n[u]))throw Error('Invalid "'+e+'" module action "'+t+'" requested');var f,h=this,p=this.getCurrent(),d=this.getExistingItem(e,t),m=null,g=!1,v=null;if(null!==p&&p===d)return p.fire(this.Event.URL_CHANGED),this.fire({type:this.Event.PARAMETERS_CHANGED,module:e,action:t,parameters:c}),void 0;if(null!==d){for(;this._stack.length>0;)if(f=this.peekLast(),f!==p){if(f===d)break;this.popLast(),f.fire(this.Event.EXIT),f.container.remove()}else this.popLast();g=!0,d.fire(this.Event.WAKEUP)}g?p.fire(this.Event.EXIT):(r.parameters=c,r.registerController(s+"."+u,n[u]),m=this.appendNavigation(e,t,c,n),m.fire=function(e,t){var n=this.container.data("$scope");o.isObject(n)&&o.isFunction(n.$broadcast)&&n.$broadcast(e,t)},null!==p&&p.fire(this.Event.SLEEP)),v=a.showView(e,t,s,u,c,n,i,null!==p?p.container:null,null!==d?d.container:null,null!==m?m.id:null,g,function(){g&&(p.fire(h.Event.EXIT),p.container.remove()),h.fire({type:h.Event.POST_NAVIGATE,module:e,action:t,parameters:c}),l.resolve(),r.validate()}),null!==m&&(m.container=v)},c.prototype.partial=function(e,t,i,u,l){i=i||"index",u=u||[],l=o.isBoolean(l)?l:!1,this._partialRendering=!0;var c=this,f=new n,h=o.convertEntityName(t)+"Module",p=o.convertCallableName(i)+"Action",d="modules/"+t+"/style/"+t+"-module.css",m="modules/"+t+"/views/"+t+"-"+i+".html",g=null;return this.fire({type:this.Event.PRE_PARTIAL,containerSelector:e,module:t,action:i,parameters:u}),o.when(s.loadModule(t),s.loadView(m),s.loadCss(d)).done(function(n,o){g=a.showPartial(t,i,h,p,u,n,o,e,l),c.fire({type:c.Event.POST_PARTIAL,containerSelector:e,module:t,action:i,parameters:u}),f.resolve(g),r.validate(),c._partialRendering=!1}).fail(function(){throw Error('Loading module "'+t+'" resources failed')}),f.promise()},c.prototype.back=function(){var e=this.getCurrent(),t=this.getPrevious();null!==e&&null!==t&&window.history.back()},c.prototype.setUrlParameter=function(e,t,n){if(o.isFunction(this.router.setUrlParameter))return this.router.setUrlParameter(e,t,n);var r,i=this.getCurrent();return null===i?!1:(r=o.clone(i),r.parameters[e]=t,this.open(r.module,r.action,r.parameters),void 0)},c.prototype.getCurrent=function(){return 0===this._stack.length?null:this._stack[this._stack.length-1]},c.prototype.getPrevious=function(){return 2>this._stack.length?null:this._stack[this._stack.length-2]},c.prototype.isBackPossible=function(){return this._stack.length>=2},c.prototype.clearHistory=function(){this._stack=[],this.fire({type:this.Event.STACK_CHANGED,stack:this._stack})},c.prototype.getExistingItem=function(e,t){var n,r;for(n=0;this._stack.length>n;n++)if(r=this._stack[n],r.module===e&&r.action===t)return r;return null},c.prototype.getStack=function(){return this._stack},c.prototype._onUrlChanged=function(e){this.fire({type:this.Event.URL_CHANGED,parameters:e})},c.prototype._popLastAction=function(e){if(e=e||1,this._stack.length>=2){for(var t=0;e>t;t++)this._removeCurrentAction();var n=this._stack.pop();return this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),n}return null},c.prototype.peekLast=function(){return 0===this._stack.length?null:this._stack[this._stack.length-1]},c.prototype.popLast=function(){if(0===this._stack.length)return null;var e=this._stack.pop();return this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),e},c.prototype._removeCurrentAction=function(){this._stack.length>=1&&this._stack.pop(),this.fire({type:this.Event.STACK_CHANGED,stack:this._stack})},c.prototype.appendNavigation=function(e,t,n,r){return this._stack.push({id:this._naviCounter++,module:e,action:t,parameters:n,instance:r,level:this._stack.length,container:null,fire:function(){}}),this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),this._stack[this._stack.length-1]},c.prototype._onKeyEvent=function(e){var t=this.getCurrent();null!==t&&o.isFunction(t.fire)&&t.fire(e.type,e)},c.prototype._onMouseEvent=function(e){var t=this.getCurrent();null!==t&&o.isFunction(t.fire)&&t.fire(e.type,e)},new c});