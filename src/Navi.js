define(["Bindable","Deferred","App","Debug","Util","UI","ResourceManager","Keyboard","Mouse","config/main"],function(t,e,n,r,i,o,a,s,u,c){var l=function(){this.backPossible=!1,this._stack=[],this._naviCounter=0,this._partialRendering=!1};return l.prototype=new t,l.prototype.Event={PRE_NAVIGATE:"pre-navigate",POST_NAVIGATE:"post-navigate",PRE_PARTIAL:"pre-partial",POST_PARTIAL:"post-partial",STACK_CHANGED:"stack-changed",SLEEP:"sleep",WAKEUP:"wakeup",EXIT:"exit"},l.prototype.init=function(){var t=this;return s.bind([s.Event.KEYDOWN,s.Event.KEYUP],function(e){t._onKeyEvent(e.info)}),u.bind([u.Event.MOUSEDOWN,u.Event.MOUSEUP,u.Event.MOUSEMOVE],function(e){t._onMouseEvent(e.info)}),this.bind(this.Event.STACK_CHANGED,function(){t.backPossible=t.isBackPossible()}),this},l.prototype.open=function(t,s,u){if(s=s||"index",u=u||[],o.isTransitioning())return r.log("! Alrady transitioning"),void 0;var c=this,l=new e,f=i.convertEntityName(t)+"Module",h=i.convertCallableName(s)+"Action",p="modules/"+t+"/style/"+t+"-module.css",d="modules/"+t+"/views/"+t+"-"+s+".html",m=null;return this.fire({type:this.Event.PRE_NAVIGATE,module:t,action:s,parameters:u}),i.when(a.loadModule(t),a.loadView(d),a.loadCss(p)).done(function(e,r){m=o.showView(t,s,f,h,u,e,r,function(){c.fire({type:c.Event.POST_NAVIGATE,module:t,action:s,parameters:u}),l.resolve(m),n.validate()})}).fail(function(){throw Error('Loading module "'+t+'" resources failed')}),l.promise()},l.prototype.partial=function(t,n,r,s,u){r=r||"index",s=s||[],u=i.isBoolean(u)?u:!1,this._partialRendering=!0;var c=this,l=new e,f=i.convertEntityName(n)+"Module",h=i.convertCallableName(r)+"Action",p="modules/"+n+"/style/"+n+"-module.css",d="modules/"+n+"/views/"+n+"-"+r+".html",m=null;return this.fire({type:this.Event.PRE_PARTIAL,containerSelector:t,module:n,action:r,parameters:s}),i.when(a.loadModule(n),a.loadView(d),a.loadCss(p)).done(function(e,i){m=o.showPartial(n,r,f,h,s,e,i,t,u),c.fire({type:c.Event.POST_PARTIAL,containerSelector:t,module:n,action:r,parameters:s}),l.resolve(m),c._partialRendering=!1}).fail(function(){throw Error('Loading module "'+n+'" resources failed')}),l.promise()},l.prototype.back=function(){var t=this,e=this.getCurrent(),r=this.getPrevious();if(null!==e&&null!==r){if(null===r&&(e.module!==c.index.module||e.action!==c.index.action))return this.open(c.index.module,c.index.action,c.index.parameters),void 0;this._stack.pop(),this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),r.injector.get("$rootScope").$digest(),r.fire(this.Event.WAKEUP),this.fire({type:this.Event.PRE_NAVIGATE,module:r.module,action:r.action,parameters:r.parameters});var i="#content-"+e.id,a="#content-"+r.id;o.transitionView(i,a,!0,!0,function(){e.fire(t.Event.EXIT),e.injector.get("$rootScope").$emit("$destroy"),t.fire({type:t.Event.POST_NAVIGATE,module:r.module,action:r.action,parameters:r.parameters}),n.validate()})}},l.prototype.getCurrent=function(){return 0===this._stack.length?null:this._stack[this._stack.length-1]},l.prototype.getPrevious=function(){return 2>this._stack.length?null:this._stack[this._stack.length-2]},l.prototype.isBackPossible=function(){return this._stack.length>=2},l.prototype.clearHistory=function(){this._stack=[],this.fire({type:this.Event.STACK_CHANGED,stack:this._stack})},l.prototype.getExistingItem=function(t,e){var n,r;for(n=0;this._stack.length>n;n++)if(r=this._stack[n],r.module===t&&r.action===e)return r;return null},l.prototype.getStack=function(){return this._stack},l.prototype._popLastAction=function(t){if(t=t||1,this._stack.length>=2){for(var e=0;t>e;e++)this._removeCurrentAction();var n=this._stack.pop();return this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),n}return null},l.prototype._removeCurrentAction=function(){this._stack.length>=1&&this._stack.pop(),this.fire({type:this.Event.STACK_CHANGED,stack:this._stack})},l.prototype.appendNavigation=function(t,e,n,r){return this._stack.push({id:this._naviCounter++,module:t,action:e,parameters:n,instance:r,level:this._stack.length,container:null,fire:function(){}}),this.fire({type:this.Event.STACK_CHANGED,stack:this._stack}),this._stack[this._stack.length-1]},l.prototype._onKeyEvent=function(t){var e=this.getCurrent();null!==e&&i.isFunction(e.fire)&&e.fire(t.type,t)},l.prototype._onMouseEvent=function(t){var e=this.getCurrent();null!==e&&i.isFunction(e.fire)&&e.fire(t.type,t)},new l});