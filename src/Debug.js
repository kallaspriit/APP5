define(["EventEmitter","Util","underscore"],function(e,t,n){var r=function(){e.call(this),this._queue={error:[],log:[],console:[],alert:[]},this._archive={error:[],log:[],console:[],alert:[]};var t=this;this._nativeAlert=window.alert,window.alert=function(e){t.alert(e)},window.onerror=function(e,n,r){return t._onError(e,n,r)===!1?!1:!0}};return r.prototype=Object.create(e.prototype),r.prototype.Event={ERROR:"error",CONSOLE:"console",LOG:"log",ALERT:"alert"},r.prototype.init=function(){return this},r.prototype.error=function(){var e=this._getSource();return this._queue.error.push([n.toArray(arguments),e]),this._flush(),this},r.prototype.log=function(){var e=this._getSource();return this._queue.log.push([n.toArray(arguments),e]),this._flush(),this},r.prototype.console=function(){var e=this._getSource();return this._queue.console.push([n.toArray(arguments),e]),this._flush(),this},r.prototype.alert=function(){var e=this._getSource();return this._queue.alert.push([n.toArray(arguments),e]),this._flush(),this},r.prototype._onListenerAdded=function(){this._flush()},r.prototype._flush=function(){var e,t,n;if(this.listenerCount(this.Event.ERROR)>0)for(;this._queue.error.length>0;)e=this._queue.error.shift(),t=e[0],n=e[1],this.emit({type:this.Event.ERROR,args:t,source:n}),this._archive.error.push(t);if(this.listenerCount(this.Event.LOG)>0)for(;this._queue.log.length>0;)e=this._queue.log.shift(),t=e[0],n=e[1],this.emit({type:this.Event.LOG,args:t,source:n}),this._archive.log.push(t);if(this.listenerCount(this.Event.CONSOLE)>0)for(;this._queue.console.length>0;)e=this._queue.console.shift(),t=e[0],n=e[1],this.emit({type:this.Event.CONSOLE,args:t,source:n}),this._archive.console.push(t);if(this.listenerCount(this.Event.ALERT)>0)for(;this._queue.alert.length>0;)e=this._queue.alert.shift(),t=e[0],n=e[1],this.emit({type:this.Event.ALERT,args:t,source:n}),this._archive.alert.push(t)},r.prototype._onError=function(e,t,n){window.console.log("error",arguments),this.error(e,t,n)},r.prototype._getSource=function(e){e=e||3;try{var n=Error().stack.split("\n"),r=n[e],i=t.parseStackLine(r);return null===i?null:"Debug.js"==i.filename.substr(i.filename.length-8)&&3===e?this._getSource(5):i}catch(o){return null}},new r});