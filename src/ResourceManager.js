define(["jquery","Bindable","Deferred","Util","Translator","config/main"],function(t,e,n,r,i,o){var a=function(){this._modules={},this._views={},this._loadedCssFiles={}};return a.prototype=new e,a.prototype.Event={MODULE_LOADED:"module-loaded",VIEW_LOADED:"view-loaded",LOAD_ERROR:"load-error"},a.prototype.ResourceType={FILE:"file",MODULE:"module",MODULE_TRANSLATIONS:"module-translations",VIEW:"view",CSS:"css",REQUEST:"request"},a.prototype.HTTP={GET:"GET",POST:"POST"},a.prototype.init=function(){var t=this;return require.onError=function(e){t.fire({type:t.Event.LOAD_ERROR,resource:t.ResourceType.FILE,error:e})},this},a.prototype.request=function(e,n,i,o,a){var s=this;return n=n||this.HTTP.GET,a=a||"json",i=i||null,".html"===e.substr(e.length-5)&&(a="html"),t.ajax({url:e,dataType:a,type:n,data:i,cache:!1}).success(function(t){r.isFunction(o)&&o(t)}).fail(function(t,a,u){r.isFunction(o)&&o(null),s.fire({type:s.Event.LOAD_ERROR,resource:s.ResourceType.REQUEST,url:e,dataType:n,data:i,xhr:t,message:a,error:u})})},a.prototype.get=function(t,e,n,i){var o;return o=r.isFunction(e)&&r.isUndefined(i)?[t,this.HTTP.GET,null,e,n]:[t,this.HTTP.GET,e,n,i],this.request.apply(this,o)},a.prototype.post=function(t,e,n,i){var o;return o=r.isFunction(e)&&r.isUndefined(i)?[t,this.HTTP.POST,null,e,n]:[t,this.HTTP.POST,e,n,i],this.request.apply(this,o)},a.prototype.loadModule=function(t,e){var a=this,s=new n,u=r.convertEntityName(t)+"Module",c=t+"-translations.js",l="modules/"+t+"/"+u,f="modules/"+t+"/"+c;return r.isObject(this._modules[t])?(s.resolve(this._modules[t]),r.isFunction(e)&&e(this._modules[t]),s.promise()):(require([l,f],function(n,c){if(!r.isObject(n))throw a.fire({type:a.Event.LOAD_ERROR,resource:a.ResourceType.MODULE,name:t,filename:l}),Error('Loading module "'+t+'" from "'+l+'" failed');if(!r.isObject(c))throw a.fire({type:a.Event.LOAD_ERROR,resource:a.ResourceType.MODULE_TRANSLATIONS,name:t,filename:f}),Error('Loading module "'+t+'" translations from "'+f+'" failed');var h,p;if(r.isObject(c))for(h in c)for(p in c[h])i.addTranslation(t+"."+h,p,c[h][p]);n.$name=t;for(var d in n)"Action"===d.substr(d.length-6)&&(n[d].$module=t,n[d].$name=d);if(o.debug&&(window.app.modules[u]=n),a.fire({type:a.Event.MODULE_LOADED,name:t,module:n}),!r.isObject(n))throw Error('Invalid module "'+t+'" requested');a._modules[t]=n,s.resolve(n),r.isFunction(e)&&e(n)}),s.promise())},a.prototype.loadView=function(t,e){var i=this,o=new n;return r.isString(this._views[t])?(r.isFunction(e)&&e(this._views[t]),o.resolve(this._views[t]),o.promise()):(this.get(t).success(function(n){i.fire({type:i.Event.VIEW_LOADED,filename:t,content:n}),i._views[t]=n,o.resolve(n),r.isFunction(e)&&e(n)}).error(function(){i.fire({type:i.Event.LOAD_ERROR,resource:i.ResourceType.VIEW,filename:t}),o.reject("Loading view from "+t+" failed")}),o.promise())},a.prototype.loadCss=function(t,e){var i=this,o=new n;if(!r.isUndefined(this._loadedCssFiles[t]))return o.resolve(this._loadedCssFiles[t]),o.promise();var a,s,u,c,l=document.getElementsByTagName("head")[0],f=document.createElement("link");return f.setAttribute("href",t),f.setAttribute("rel","stylesheet"),f.setAttribute("type","text/css"),"sheet"in f?(a="sheet",s="cssRules"):(a="styleSheet",s="rules"),u=setInterval(function(){try{f[a]&&f[a][s].length&&(clearInterval(u),clearTimeout(c),i._loadedCssFiles[t]=f,o.resolve(f),r.isFunction(e)&&e.call(e,!0,f))}catch(n){}},10),c=setTimeout(function(){clearInterval(u),clearTimeout(c),l.removeChild(f),i.fire({type:i.Event.LOAD_ERROR,resource:i.ResourceType.CSS,filename:t}),o.reject('Loading css "'+t+'" failed'),r.isFunction(e)&&e.call(e,!1,f)},1e4),l.appendChild(f),o.promise()},new a});