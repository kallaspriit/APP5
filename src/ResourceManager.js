define(["jquery","EventEmitter","Deferred","Util","Translator","config/main"],function(e,t,n,r,i,o){var a=function(){t.call(this),this._modules={},this._views={},this._loadedCssFiles={}};return a.prototype=Object.create(t.prototype),a.prototype.Event={MODULE_LOADED:"module-loaded",VIEW_LOADED:"view-loaded",LOAD_ERROR:"load-error"},a.prototype.ResourceType={FILE:"file",MODULE:"module",MODULE_TRANSLATIONS:"module-translations",VIEW:"view",CSS:"css",REQUEST:"request"},a.prototype.HTTP={GET:"GET",POST:"POST"},a.prototype.init=function(){var e=this;return require.onError=function(t){e.emit({type:e.Event.LOAD_ERROR,resource:e.ResourceType.FILE,error:t})},this},a.prototype.request=function(t,n,i,o,a){var s=this;return n=n||this.HTTP.GET,a=a||"json",i=i||null,".html"===t.substr(t.length-5)&&(a="html"),e.ajax({url:t,dataType:a,type:n,data:i,cache:!1}).success(function(e){r.isFunction(o)&&o(e)}).fail(function(e,a,l){r.isFunction(o)&&o(null),s.emit({type:s.Event.LOAD_ERROR,resource:s.ResourceType.REQUEST,url:t,dataType:n,data:i,xhr:e,message:a,error:l})})},a.prototype.get=function(e,t,n,i){var o;return o=r.isFunction(t)&&r.isUndefined(i)?[e,this.HTTP.GET,null,t,n]:[e,this.HTTP.GET,t,n,i],this.request.apply(this,o)},a.prototype.post=function(e,t,n,i){var o;return o=r.isFunction(t)&&r.isUndefined(i)?[e,this.HTTP.POST,null,t,n]:[e,this.HTTP.POST,t,n,i],this.request.apply(this,o)},a.prototype.loadModule=function(e,t){var a=this,s=new n,l=r.convertEntityName(e)+"Module",u=e+"-translations.js",c="modules/"+e+"/"+l,p="modules/"+e+"/"+u;return r.isObject(this._modules[e])?(s.resolve(this._modules[e]),r.isFunction(t)&&t(this._modules[e]),s.promise()):(require([c,p],function(n,u){if(!r.isObject(n))throw a.emit({type:a.Event.LOAD_ERROR,resource:a.ResourceType.MODULE,name:e,filename:c}),Error('Loading module "'+e+'" from "'+c+'" failed');if(!r.isObject(u))throw a.emit({type:a.Event.LOAD_ERROR,resource:a.ResourceType.MODULE_TRANSLATIONS,name:e,filename:p}),Error('Loading module "'+e+'" translations from "'+p+'" failed');var f,d;if(r.isObject(u))for(f in u)for(d in u[f])i.addTranslation(e+"."+f,d,u[f][d]);n.$name=e;for(var h in n)"Action"===h.substr(h.length-6)&&(n[h].$module=e,n[h].$name=h);if(o.debug&&(window.app.modules[l]=n),a.emit({type:a.Event.MODULE_LOADED,name:e,module:n}),!r.isObject(n))throw Error('Invalid module "'+e+'" requested');a._modules[e]=n,s.resolve(n),r.isFunction(t)&&t(n)}),s.promise())},a.prototype.loadView=function(e,t){var i=this,o=new n;return r.isString(this._views[e])?(r.isFunction(t)&&t(this._views[e]),o.resolve(this._views[e]),o.promise()):(this.get(e).success(function(n){i.emit({type:i.Event.VIEW_LOADED,filename:e,content:n}),i._views[e]=n,o.resolve(n),r.isFunction(t)&&t(n)}).error(function(){i.emit({type:i.Event.LOAD_ERROR,resource:i.ResourceType.VIEW,filename:e}),o.reject("Loading view from "+e+" failed")}),o.promise())},a.prototype.loadCss=function(e,t){var i=this,o=new n;if(!r.isUndefined(this._loadedCssFiles[e]))return o.resolve(this._loadedCssFiles[e]),o.promise();var a,s,l,u,c=document.getElementsByTagName("head")[0],p=document.createElement("link");return p.setAttribute("href",e),p.setAttribute("rel","stylesheet"),p.setAttribute("type","text/css"),"sheet"in p?(a="sheet",s="cssRules"):(a="styleSheet",s="rules"),l=setInterval(function(){try{p[a]&&p[a][s].length&&(clearInterval(l),clearTimeout(u),i._loadedCssFiles[e]=p,o.resolve(p),r.isFunction(t)&&t.call(t,!0,p))}catch(n){}},10),u=setTimeout(function(){clearInterval(l),clearTimeout(u),c.removeChild(p),i.emit({type:i.Event.LOAD_ERROR,resource:i.ResourceType.CSS,filename:e}),o.reject('Loading css "'+e+'" failed'),r.isFunction(t)&&t.call(t,!1,p)},1e4),c.appendChild(p),o.promise()},new a});