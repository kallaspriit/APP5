define(["jquery","Bindable","Deferred","Util","Translator","config/main"],function(t,e,n,r,i,o){var a=function(){this._modules={},this._views={},this._loadedCssFiles={}};return a.prototype=new e,a.prototype.Event={MODULE_LOADED:"module-loaded",VIEW_LOADED:"view-loaded"},a.prototype.HTTP={GET:"GET",POST:"POST"},a.prototype.init=function(){return this},a.prototype.request=function(e,n,i,o,a){return n=n||this.HTTP.GET,a=a||"json",i=i||null,".html"===e.substr(e.length-5)&&(a="html"),t.ajax({url:e,dataType:a,type:n,data:i,cache:!1}).success(function(t){r.isFunction(o)&&o(t)}).fail(function(){r.isFunction(o)&&o(null)})},a.prototype.get=function(t,e,n,i){var o;return o=r.isFunction(e)&&r.isUndefined(i)?[t,this.HTTP.GET,null,e,n]:[t,this.HTTP.GET,e,n,i],this.request.apply(this,o)},a.prototype.post=function(t,e,n,i){var o;return o=r.isFunction(e)&&r.isUndefined(i)?[t,this.HTTP.POST,null,e,n]:[t,this.HTTP.POST,e,n,i],this.request.apply(this,o)},a.prototype.loadModule=function(t,e){var a=this,s=new n,u=r.convertEntityName(t)+"Module",c=t+"-translations.js";return r.isObject(this._modules[t])?(s.resolve(this._modules[t]),r.isFunction(e)&&e(this._modules[t]),s.promise()):(require(["modules/"+t+"/"+u,"modules/"+t+"/"+c],function(n,c){var l,f;if(r.isObject(c))for(l in c)for(f in c[l])i.addTranslation(t+"."+l,f,c[l][f]);n.$name=t;for(var h in n)"Action"===h.substr(h.length-6)&&(n[h].$module=t,n[h].$name=h);if(o.debug&&(window.app.modules[u]=n),a.fire({type:a.Event.MODULE_LOADED,name:t,module:n}),!r.isObject(n))throw Error('Invalid module "'+t+'" requested');a._modules[t]=n,s.resolve(n),r.isFunction(e)&&e(n)}),s.promise())},a.prototype.loadView=function(t,e){var i=this,o=new n;return r.isString(this._views[t])?(r.isFunction(e)&&e(this._views[t]),o.resolve(this._views[t]),o.promise()):(this.get(t).success(function(n){i.fire({type:i.Event.VIEW_LOADED,filename:t,content:n}),i._views[t]=n,o.resolve(n),r.isFunction(e)&&e(n)}).error(function(){o.reject("Loading view from "+t+" failed")}),o.promise())},a.prototype.loadCss=function(t,e){var i=this,o=new n;if(!r.isUndefined(this._loadedCssFiles[t]))return o.resolve(this._loadedCssFiles[t]),o.promise();var a,s,u,c,l=document.getElementsByTagName("head")[0],f=document.createElement("link");return f.setAttribute("href",t),f.setAttribute("rel","stylesheet"),f.setAttribute("type","text/css"),"sheet"in f?(a="sheet",s="cssRules"):(a="styleSheet",s="rules"),u=setInterval(function(){try{f[a]&&f[a][s].length&&(clearInterval(u),clearTimeout(c),i._loadedCssFiles[t]=f,o.resolve(f),r.isFunction(e)&&e.call(e,!0,f))}catch(n){}},10),c=setTimeout(function(){clearInterval(u),clearTimeout(c),l.removeChild(f),o.reject('Loading css "'+t+'" failed'),r.isFunction(e)&&e.call(e,!1,f)},1e4),l.appendChild(f),o.promise()},new a});